<!DOCTYPE html>
<html>
    <head>
        <title>Sequence Editor</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!--CSS style sheets-->
        <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link href="css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
        <script type="text/javascript" src="jsLibraries/jquery-1.9.1.min.js"></script> 
        <script type="text/javascript" src="jsLibraries/jquery-ui.min.js"></script>
        <script src="jsLibraries/jwerty.js"></script>
        <style>
            .resizable { width: 150px; height: 150px; padding: 0.5em; }
            .resizable h4 { text-align: center; margin: 0; }
            textArea {
                font-size: 22pt;
                font-family: monospace;
                padding:0px;
                line-height: 22pt;
            }
            #highlight{
                font-size: 22pt;
                font-family: monospace; 
                padding:0px;
                line-height: 22pt;
                color:transparent;
            }
            span{
                line-height: 22pt;
                font-size: 22pt;
                font-family: monospace; 
                word-wrap: break-word;
                padding:0px;
                margin: 0px;
                border:0px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class='row' id="testArea">
                <!--this is the text area you're typing into-->
                <div class ='span6'>
                    <textarea id="testText" style="overflow:auto;resize:none;width: 500px;height:500px;background-color: transparent;"></textarea>
                </div>
                <div class ='span6'>
                    <!--this is the highlight layer-->
                    <div id="highlight" style="overflow:auto;word-wrap: break-word;width:500px;height:500px;z-index: 1;position:relative;"></div>
                </div>
            </div>
            <div class="row" id="sampleFeatures">
                <ul class="nav nav-pills">
                    <li class="active"><a id="sample1" href="#">Sample 1</a></li>
                    <li class="active"><a id="sample2" href="#">Sample 2</a></li>
                    <li class="active"><a id="sample3" href="#">Sample 3</a></li>
                    <li class="active"><a id="clear" href="#">Clear</a></li>
                </ul>
            </div>
        </div>
        <!--top:-511px-->
        <!--javascript libraries-->
        <script src="jsLibraries/bootstrap.min.js"></script> 
        <script src="jsLibraries/jquery.filter_input.js"></script>
        <!--javascript goes here-->
        <script>
            $(document).ready(function() {
                $('#testText').filter_input({regex: '[actguryswkmbdhvnACTGURYSWKMBDHVN]'});

                $('#testText').scroll(function() {
                    $('#highlight').scrollTop($(this).scrollTop());
                });
                ////////////////////////////////////////////////////////////////
                $('#testText').mousedown(function() {
                    $('#highlight').css("z-index", -1);
                    $('#highlight span').css("color", "transparent");
                    $('#testText').css("color", "black");
                });
                $('#highlight').mousedown(function() {
                    $('#highlight').css("z-index", -1);
                    $('#highlight span').css("color", "transparent");
                    $('#testText').css("color", "black");
                });
                $('#testText').mouseleave(function() {
                    $('#highlight').css("z-index", 1);
                    $('#highlight span').css("color", "black");
                });
                ////////////////////////////////////////////////////////////////

                jwerty.key('alt+h', false);
                jwerty.key('alt+h', function() {
                    $.get("SequenceEditorServlet", {"command": "genbank"}, function(response) {
                        resolveFeatureOverlap(response["sequence"], response["features"]);
                    });
                });
                //generate feature list
                var spansToHighlight = []; //stores highlight regions
                var features = []; //stores current features
                function resolveFeatureOverlap(seq, featureList) {
                    var sequence = seq;
//                    var features = [];
                    var indexCount = 0;
                    var orderedIndeces = [];
                    $.each(featureList, function(index, d) {
                        var startIndex = sequence.indexOf(d.sequence);
                        var endIndex = startIndex + (d.sequence).length;
                        features.push({name: d.name, sequence: d.sequence, start: startIndex, end: endIndex, color: d.color});
                        orderedIndeces.push(startIndex);
                        orderedIndeces.push(endIndex);
                        indexCount++;
                    });
                    orderedIndeces.sort(function(a, b) {
                        return a - b;
                    });

                    var kk = 0;
                    for (var ii = 0; ii < orderedIndeces.length; ii++) {
                        var overlappingFeatures = "";
                        var startingIndex = "";
                        var endingIndex = "";
                        var spanColor = "";
                        var count = 0;
                        for (var jj = kk; jj < indexCount; jj++) {
                            if (jj === kk) {
                                startingIndex = orderedIndeces[ii];
                                endingIndex = orderedIndeces[ii + 1];
                            }
                            if ((features[jj].start >= orderedIndeces[ii]) && (features[jj].start < orderedIndeces[ii + 1])) {
                                overlappingFeatures += features[jj].name + ",";
                                count = jj;
                            }
                            else if ((features[jj].start >= orderedIndeces[ii]) && (features[jj].end <= orderedIndeces[ii + 1])) {
                                overlappingFeatures += features[jj].name + ",";
                                count = jj;
                            }
                            else if ((features[jj].end > orderedIndeces[ii]) && (features[jj].end <= orderedIndeces[ii + 1])) {
                                overlappingFeatures += features[jj].name + ",";
                                count = jj;
                            }
                            else if ((features[jj].start <= orderedIndeces[ii]) && (features[jj].end >= orderedIndeces[ii + 1])) {
                                overlappingFeatures += features[jj].name + ",";
                                count = jj;
                            }
                        }

                        if (overlappingFeatures === "") {
                            spanColor = "";
                        } else {
                            overlappingFeatures = overlappingFeatures.substring(0, overlappingFeatures.length - 1);
                            spanColor = features[count].color;
                        }
                        spansToHighlight.push({start: startingIndex, end: endingIndex, features: overlappingFeatures, color: spanColor});
                    }
//                    var features = [{"name": "feature1", "start": 0, "end": 3, "color": "yellow"}, {"name": "feature2", "start": 3, "end": 10, "color": "yellow"}, {"name": "", "start": 10, "end": 12, "color": "yellow"}, {"name": "feature3", "start": 12, "end": 30, "color": "yellow"}];
                }

                $('#testText').keyup(function() {
                    var unparsed = $('#testText').val().toString();
                    ////// send updated sequence/features to resolveFeatureOverlap function and return new spansToHighlight object
                    var updatedFeatures = [];
                    for (var jj = 0; jj < features.length; jj++) {
                        var regexSeq = new RegExp(features[jj].sequence, "g");
                        var matches = [];
                        matches.push(unparsed.search(regexSeq));
                        if (matches >= 0) {
                            for (var bb = 0; bb < matches.length; bb++) {
                                var startIndex = matches;
                                var endIndex = parseInt(startIndex) + parseInt((features[jj].sequence).length);
                                updatedFeatures.push({name: features[jj].name, sequence: features[jj].sequence, start: startIndex, end: endIndex, color: features[jj].color});
                            }
//                            alert(updatedFeatures[jj].sequence);
//                            alert(updatedFeatures[jj].start + ".." + updatedFeatures[jj].end);
                        }
                    }
                    features = updatedFeatures;
                    resolveFeatureOverlap(unparsed, features);
                    //////

                    var parsed = "";
                    //iterate through each feature and append regular text or a span
                    for (var i = 0; i < spansToHighlight.length; i++) {
                        var start = spansToHighlight[i].start;
                        var end = spansToHighlight[i].end;
                        var name = spansToHighlight[i].features;
                        var color = spansToHighlight[i].color;
                        if (i === 0 && start !== 0) {
                            parsed = parsed + unparsed.substring(0, start);
                        }
                        if (name === "") {
                            //just add text if no feature appears
                            parsed = parsed + unparsed.substring(start, end);
                        } else {
                            parsed = parsed + '<span title="' + name + '" style="background-color:' + color + '">' + unparsed.substring(start, end) + '</span>';
                        }
                    }
                    //set the html of the highlight layer
                    $('#highlight').html(parsed);
                    $('#highlight').css("z-index", -1);
                    $('#highlight span').css("color", "transparent");
                    $('#testText').css("color", "black");
                });
                var samples = [];
                //Create dummy Genbank sequence/feature samples
                var sample1 = {sequence: "ATTGCGTTATGGAAATTCGAAACTGCCAAATACTATGTCACCATCATTGATGCACCTGGACACAGAGATTTCATCAAGAACATGATCACTGGTACTT",
                    features: [{name: "feature1", sequence: "GCGTTA", color: "red"},
                        {name: "feature2", sequence: "TTCGAAACTGCCAAA", color: "cyan"},
                        {name: "feature3", sequence: "AAATACTATGTCACCATCATTGATGCACCTGGACACAGA", color: "green"},
                        {name: "feature4", sequence: "AGAGATTTCATCAAGAACATGATCACTGGTA", color: "yellow"}]
                };
                var sample2 = {sequence: "ATGGAGCATACATATCAATATTCATGGATCATACCGTTTGTGCCACTTCCAATTCCTATTTTAATAGGAATTGGACTCCTACTTTTTCCGACGGCAACAAAAAATCTTCGTCGTATGTGGGCTCTTCCCAATATTTTATTGTTAAGTATAGTTATGATTTTTTCGGTCGATCTGTCCATTCAGCAAATAAATAAAAGTTCTATCTATCAATATGTATGGTCTTGGACCATCAATAATGATTTTTCTTTCGAGTTTGGCTACTTTATTGATTCGCTTACCTAGTTCGAATTTGATAAAATTTATATTTTTTGGGAATTAGTTGGAATGTGTTCTTATCTATTAATAGGGTTTTGGTTCACACGACCCGCTGCGGCAAACGCCTGTCAAAAAGCATTTGTAACTAATCGGATAGGCGATTTTGGTTTATTATTAGGAATCTTAGGTTTTTATTGGATAACGGGAAGTTTCGAATTTCAAGATTTGTTCGAAATATTTAATAACTTGATTTATAATAATGAGGTTCAGTTTTTATTTGTTACTTTATGTGCCTCTTTATTA",
                    features: [{name: "feature1", sequence: "TTGTGCCACTTCCAATTCCTATTTTAATAGGAATTGGAC", color: "red"},
                        {name: "feature2", sequence: "AATTCC", color: "cyan"},
                        {name: "feature3", sequence: "CAACAAAAAATCTTCGTCGTATGTGGGCTCTTCCCAATAT", color: "green"},
                        {name: "feature4", sequence: "TTGTTAAGTATAGTTATGATTTTTTCGGTCGATCTGTCCATTCAGCAAATAAATAAAAGTTCTATCTATCAATATGTATGGTCTTGGACCATCAATAATGATTTTTCTTTCGAGTTTGGCTACTTTATTGATTCGCTTACCTAGTTCGAATTTGATAAAATTTATATTTTTTGGGAATTAGTTGGAATGTGTTCTTATCTATTAATAGGGTTTTGGTTCACACGACCCGCTGCGGCAAACGCCTGTCAAAAAGCATTTGTAACTAATCGGATAGGCGATTTTGGTTTATTATTAGGAATCTTAGGTTTTTATTGGATAACGGGAAGTTTCGAATTTCAAGATTTGTTCGAAATATTTAATAACTTGATTTATAATAA", color: "yellow"}]
                };
                var sample3 = {sequence: "TCAATAAAACTATGGGGTAAAGAAGAACAAAAAATAATTAACAGAAATTTTCGTTTATCTCCTTTATTAATATTAACGATGAATAATAATGAGAAGCCATATAGAATTGGTGATAATGTAAAAAAAGGGGCTCTTATTACTATTACGAGTTTTGGCTACAAGAAGGCTTTTTCTTATCCTCATGAATCGGATAATACTATGCTATTTCCTATGCTTATATTGGCTCTATTTACTTTTTTTGTTGGAGCCATAGCAATTCCTTTTAATCAAGAAGGACTACATTTGGATATATTATCCAAATTATTAACTCCATCTATAAATCTTTTACATCAAAATTCAAATGATTTTGAGGATTGGTATCAATTTTTAACAAATGCAACTCTTTCAGTGAGTATAGCCTGTTTCGGAATATTTACAGCATTCCTTTTATATAAGCCTTTTTATTCATCTTTACAAAATTTGAACTTACTAAATTTATTTTCGAAAGGGGGTCCTAAAAGAATTTTTTTGGATAAAATAATATACTTGATATACGATTGGTCATATAATCGTGGTTACATAGATACGTTTTATTCAGTATCCTTAACAAAAGGTATAAGAGGATTGGCCGAACTAACTCATTTTTTTGATAGGCGAGTAATCGATGGAATTACAAATGGAGTACGCATCACAAGTTTTTTTATAGGCGAAGGTATCAAATATT",
                    features: [{name: "feature1", sequence: "ATAATTAACAGAAATTTTCGTTTATCTCCTTTATTAATATTAACGATGAATAATAATGAGAAGCCATATAGAATTGGTGATAA", color: "red"},
                        {name: "feature2", sequence: "TATCTCCTTTATTAATATTAACGATGAATAATAATGAGAAGCCATATAGAATTGGTGATAATGTAAAAAAAGGGGCTCTTATTAC", color: "cyan"},
                        {name: "feature3", sequence: "TCCAAATTATTAACTCCATCTATAAATCTTTTACATCAAAA", color: "green"},
                        {name: "feature4", sequence: "ACTTGATATACGATTGGTCATATAATCGTGGTTACATAGATACGTTTTATTCAGTATCCTTAACAAAAGGTATAAGAGGATTGGCCGAACTAACTC", color: "yellow"}]
                };
                samples.push(sample1);
                samples.push(sample2);
                samples.push(sample3);
                $('#sample1').click(function() {
                    resolveFeatureOverlap(samples[0].sequence, samples[0].features);
                    $('#testText').val(samples[0].sequence);
                });
                $('#sample2').click(function() {
                    resolveFeatureOverlap(samples[1].sequence, samples[1].features);
                    $('#testText').val(samples[1].sequence);
                });
                $('#sample3').click(function() {
                    resolveFeatureOverlap(samples[2].sequence, samples[2].features);
                    $('#testText').val(samples[2].sequence);
                });
                $('#clear').click(function() {
                    $('#testText').val("");
                });
            });
        </script>
    </body>
</html>
