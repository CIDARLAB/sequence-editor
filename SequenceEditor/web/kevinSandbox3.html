<!DOCTYPE html>
<html>
    <head>
        <title>Sequence Editor</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!--CSS style sheets-->
        <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link href="css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
        <script type="text/javascript" src="jsLibraries/jquery-1.9.1.min.js"></script> 
        <script type="text/javascript" src="jsLibraries/jquery-ui.min.js"></script>
        <script src="jsLibraries/jwerty.js"></script>
        <style>
            .resizable { width: 150px; height: 150px; padding: 0.5em; }
            .resizable h4 { text-align: center; margin: 0; }
            textArea {
                font-size: 22pt;
                font-family: monospace;
                padding:0px;
                line-height: 22pt;
            }
            #highlight{
                font-size: 22pt;
                font-family: monospace; 
                padding:0px;
                line-height: 22pt;
                color:black;
            }
            span{
                line-height: 22pt;
                font-size: 22pt;
                font-family: monospace; 
                word-wrap: break-word;
                padding:0px;
                margin: 0px;
                border:0px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class='row-fluid' id="testArea">
                <!--this is the text area you're typing into-->
                <div class ='span6'>
                    <textarea id="testText" style="overflow:auto;resize:none;width: 500px;height:500px;background-color: transparent;"></textarea>
                </div>
                <div class ='span6'>
                    <!--this is the highlight layer-->
                    <div id="highlight" style="overflow:auto;word-wrap: break-word;width:500px;height:500px;z-index: 1;"></div>
                </div>
            </div>
            <div class="row" id="sampleFeatures">
                <ul class="nav nav-pills">
                    <li><a id="sample1" href="#">Sample 1</a></li>
                    <li><a id="sample2" href="#">Sample 2</a></li>
                    <li><a id="sample3" href="#">Sample 3</a></li>
                    <li><a id="clear" href="#">Clear</a></li>
                    <li><a id="annotate" href="#">Annotate</a></li>
                </ul>
            </div>
            <div id="index"></div>
            <div id="report"></div>
        </div>
        <!--javascript libraries-->
        <script src="jsLibraries/bootstrap.min.js"></script> 
        <script src="jsLibraries/jquery.filter_input.js"></script>
        <!--javascript goes here-->
        <script>
            var _sequence = ""; //store sequence to compare if insert or delete happened
            var samples = [];
            //Create dummy Genbank sequence/feature samples
            var sample1 = {sequence: "aaaagctacaggggccaatgacgcccctagacagtttttaacccaaaa",
                features: [{name: "feature1", sequence: "aaaa", color: "red"},
                    {name: "feature2", sequence: "cccc", color: "cyan"},
                    {name: "feature3", sequence: "gggg", color: "green"},
                    {name: "feature4", sequence: "tttt", color: "yellow"}]
            };
            var sample2 = {sequence: "ATGGAGCATACATATCAATATTCATGGATCATACCGTTTGTGCCACTTCCAATTCCTATTTTAATAGGAATTGGACTCCTACTTTTTCCGACGGCAACAAAAAATCTTCGTCGTATGTGGGCTCTTCCCAATATTTTATTGTTAAGTATAGTTATGATTTTTTCGGTCGATCTGTCCATTCAGCAAATAAATAAAAGTTCTATCTATCAATATGTATGGTCTTGGACCATCAATAATGATTTTTCTTTCGAGTTTGGCTACTTTATTGATTCGCTTACCTAGTTCGAATTTGATAAAATTTATATTTTTTGGGAATTAGTTGGAATGTGTTCTTATCTATTAATAGGGTTTTGGTTCACACGACCCGCTGCGGCAAACGCCTGTCAAAAAGCATTTGTAACTAATCGGATAGGCGATTTTGGTTTATTATTAGGAATCTTAGGTTTTTATTGGATAACGGGAAGTTTCGAATTTCAAGATTTGTTCGAAATATTTAATAACTTGATTTATAATAATGAGGTTCAGTTTTTATTTGTTACTTTATGTGCCTCTTTATTA",
                features: [{name: "feature1", sequence: "TTGTGCCACTTCCAATTCCTATTTTAATAGGAATTGGAC", color: "red"},
                    {name: "feature2", sequence: "AATTCC", color: "cyan"},
                    {name: "feature3", sequence: "CAACAAAAAATCTTCGTCGTATGTGGGCTCTTCCCAATAT", color: "green"},
                    {name: "feature4", sequence: "TTGTTAAGTATAGTTATGATTTTTTCGGTCGATCTGTCCATTCAGCAAATAAATAAAAGTTCTATCTATCAATATGTATGGTCTTGGACCATCAATAATGATTTTTCTTTCGAGTTTGGCTACTTTATTGATTCGCTTACCTAGTTCGAATTTGATAAAATTTATATTTTTTGGGAATTAGTTGGAATGTGTTCTTATCTATTAATAGGGTTTTGGTTCACACGACCCGCTGCGGCAAACGCCTGTCAAAAAGCATTTGTAACTAATCGGATAGGCGATTTTGGTTTATTATTAGGAATCTTAGGTTTTTATTGGATAACGGGAAGTTTCGAATTTCAAGATTTGTTCGAAATATTTAATAACTTGATTTATAATAA", color: "yellow"}]
            };
            var sample3 = {sequence: "TCAATAAAACTATGGGGTAAAGAAGAACAAAAAATAATTAACAGAAATTTTCGTTTATCTCCTTTATTAATATTAACGATGAATAATAATGAGAAGCCATATAGAATTGGTGATAATGTAAAAAAAGGGGCTCTTATTACTATTACGAGTTTTGGCTACAAGAAGGCTTTTTCTTATCCTCATGAATCGGATAATACTATGCTATTTCCTATGCTTATATTGGCTCTATTTACTTTTTTTGTTGGAGCCATAGCAATTCCTTTTAATCAAGAAGGACTACATTTGGATATATTATCCAAATTATTAACTCCATCTATAAATCTTTTACATCAAAATTCAAATGATTTTGAGGATTGGTATCAATTTTTAACAAATGCAACTCTTTCAGTGAGTATAGCCTGTTTCGGAATATTTACAGCATTCCTTTTATATAAGCCTTTTTATTCATCTTTACAAAATTTGAACTTACTAAATTTATTTTCGAAAGGGGGTCCTAAAAGAATTTTTTTGGATAAAATAATATACTTGATATACGATTGGTCATATAATCGTGGTTACATAGATACGTTTTATTCAGTATCCTTAACAAAAGGTATAAGAGGATTGGCCGAACTAACTCATTTTTTTGATAGGCGAGTAATCGATGGAATTACAAATGGAGTACGCATCACAAGTTTTTTTATAGGCGAAGGTATCAAATATT",
                features: [{name: "feature1", sequence: "ATAATTAACAGAAATTTTCGTTTATCTCCTTTATTAATATTAACGATGAATAATAATGAGAAGCCATATAGAATTGGTGATAA", color: "red"},
                    {name: "feature2", sequence: "TATCTCCTTTATTAATATTAACGATGAATAATAATGAGAAGCCATATAGAATTGGTGATAATGTAAAAAAAGGGGCTCTTATTAC", color: "cyan"},
                    {name: "feature3", sequence: "TCCAAATTATTAACTCCATCTATAAATCTTTTACATCAAAA", color: "green"},
                    {name: "feature4", sequence: "ACTTGATATACGATTGGTCATATAATCGTGGTTACATAGATACGTTTTATTCAGTATCCTTAACAAAAGGTATAAGAGGATTGGCCGAACTAACTC", color: "yellow"}]
            };
            samples.push(sample1);
            samples.push(sample2);
            samples.push(sample3);


            $(document).ready(function() {
                Array.prototype.remove = function(from, to) {
                    var rest = this.slice((to || from) + 1 || this.length);
                    this.length = from < 0 ? this.length + from : from;
                    return this.push.apply(this, rest);
                };

                $('#testText').filter_input({regex: '[actguryswkmbdhvnACTGURYSWKMBDHVN]'});

                $('#testText').scroll(function() {
                    $('#highlight').scrollTop($(this).scrollTop());
                });
                ////////////////////////////////////////////////////////////////
                $('#testText').mousedown(function() {
                    $('#highlight').css("z-index", -1);
//                    $('#highlight span').css("color", "transparent");
                    $('#testText').css("color", "black");
                });
                $('#highlight').mousedown(function() {
                    $('#highlight').css("z-index", -1);
//                    $('#highlight span').css("color", "transparent");
                    $('#testText').css("color", "black");
                });
                $('#testText').mouseleave(function() {
                    $('#highlight').css("z-index", 1);
                    $('#highlight span').css("color", "black");
                });
                ////////////////////////////////////////////////////////////////

                //generate feature list
                var _features = []; //stores current features
                var _annotations = [];
                for (var i = 0; i < samples.length; i++) {
                    for (var j = 0; j < samples[i]["features"].length; j++) {
                        var currentFeature = samples[i].features[j];
                        _features.push({name: currentFeature.name, sequence: currentFeature.sequence, color: currentFeature.color});
                    }
                }

                function getIndicesOf(searchStr, str, caseSensitive) {
                    var startIndex = 0, searchStrLen = searchStr.length;
                    var index, indices = [];
                    if (!caseSensitive) {
                        str = str.toLowerCase();
                        searchStr = searchStr.toLowerCase();
                    }
                    while ((index = str.indexOf(searchStr, startIndex)) > -1) {
                        indices.push(index);
                        startIndex = index + searchStrLen;
                    }
                    return indices;
                }

                getIndicesOf("le", "I learned to play the Ukulele in Lebanon.", false);


                //generates annotations: {featureName, start, end, color}
                var generateAnnotations = function(sequence, features) {
                    var unresolvedAnnotations = []; //annotations with potential overlaps
                    for (var i = 0; i < features.length; i++) {
                        var matches = getIndicesOf(features[i].sequence, sequence, false);
                        if (matches.length > 0) {
                            for (var j = 0; j < matches.length; j++) {
                                var startIndex = matches[j];
                                var endIndex = startIndex + features[i].sequence.length;
                                unresolvedAnnotations.push({name: features[i].name, sequence: features[i].sequence, start: startIndex, end: endIndex, color: features[i].color});
                            }
                        }
                    }
                    unresolvedAnnotations = unresolvedAnnotations.sort(function(a, b) {
                        if (a.start < b.start) {
                            return -1;
                        }
                        else if (a.start > b.start) {
                            return 1;
                        }
                        return 0;
                    });
                    var resolvedAnnotations = resolveFeatureOverlap(sequence, unresolvedAnnotations);
                    
                    return unresolvedAnnotations;
                };

                //resolve overlaps between annotations
                var resolveFeatureOverlap = function(seq, unresolvedAnnotations) {
                    var toReturn = [];
                    var sequence = seq;
                    var indexCount = 0;
                    var orderedIndeces = [];
                    $.each(unresolvedAnnotations, function(index, d) {
                        var startIndex = sequence.indexOf(d.sequence);
                        var endIndex = startIndex + (d.sequence).length;
                        orderedIndeces.push(startIndex);
                        orderedIndeces.push(endIndex);
                        indexCount++;
                    });
                    orderedIndeces.sort(function(a, b) {
                        return a - b;
                    });
                    var kk = 0;
                    for (var ii = 0; ii < orderedIndeces.length; ii++) {
                        var overlappingFeatures = "";
                        var startingIndex = "";
                        var endingIndex = "";
                        var spanColor = "";
                        var count = 0;
                        for (var jj = kk; jj < indexCount; jj++) {
                            if (jj === kk) {
                                startingIndex = orderedIndeces[ii];
                                endingIndex = orderedIndeces[ii + 1];
                            }
                            if ((unresolvedAnnotations[jj].start >= orderedIndeces[ii]) && (unresolvedAnnotations[jj].start < orderedIndeces[ii + 1])) {
                                overlappingFeatures += unresolvedAnnotations[jj].name + ",";
                                count = jj;
                            }
                            else if ((unresolvedAnnotations[jj].start >= orderedIndeces[ii]) && (unresolvedAnnotations[jj].end <= orderedIndeces[ii + 1])) {
                                overlappingFeatures += unresolvedAnnotations[jj].name + ",";
                                count = jj;
                            }
                            else if ((unresolvedAnnotations[jj].end > orderedIndeces[ii]) && (unresolvedAnnotations[jj].end <= orderedIndeces[ii + 1])) {
                                overlappingFeatures += unresolvedAnnotations[jj].name + ",";
                                count = jj;
                            }
                            else if ((unresolvedAnnotations[jj].start <= orderedIndeces[ii]) && (unresolvedAnnotations[jj].end >= orderedIndeces[ii + 1])) {
                                overlappingFeatures += unresolvedAnnotations[jj].name + ",";
                                count = jj;
                            }
                        }
                        if (overlappingFeatures === "") {
                            spanColor = "";
                        } else {
                            overlappingFeatures = overlappingFeatures.substring(0, overlappingFeatures.length - 1);
                            spanColor = unresolvedAnnotations[count].color;
                            toReturn.push({start: startingIndex, end: endingIndex, features: overlappingFeatures, color: spanColor});
                        }

                    }
//                    toReturn[toReturn.length - 1].end = seq.length;
                    return toReturn;
                };

                var updateAnnotationIndices = function(index, annotations, changeLength) {
                    var updatedAnnotations = [];
                    if (changeLength !== 0) {
                        for (var i = 0; i < annotations.length; i++) {
                            var start = annotations[i].start;
                            var end = annotations[i].end;
                            if (start + changeLength >= index) {
                                //change is before annotation
                                annotations[i].start = start + changeLength;
                                annotations[i].end = end + changeLength;

                            }
                            if (index > start + changeLength && index < end + changeLength) {
                                //ignore features that should be removed
                            } else {
                                updatedAnnotations.push(annotations[i]);
                            }
                        }
                        return updatedAnnotations;
                    }
                    return annotations;

                };



                var generateHighlights = function(sequence, annotationsToDraw) {
                    var toReturn = "";
                    //iterate through each feature and append regular text or a span
                    if (annotationsToDraw.length > 0) {
                        //append start of string
                        toReturn = sequence.substring(0, annotationsToDraw[0].start) + '<span title="' + annotationsToDraw[0].features + '" style="background-color:' + annotationsToDraw[0].color + '">' + sequence.substring(annotationsToDraw[0].start, annotationsToDraw[0].end) + '</span>';
                        var prevEnd = annotationsToDraw[0].end; //ending of the previous annotation
                        for (var i = 1; i < annotationsToDraw.length; i++) {
                            var start = annotationsToDraw[i].start;
                            var end = annotationsToDraw[i].end;
                            var name = annotationsToDraw[i].features;
                            var color = annotationsToDraw[i].color;
                            toReturn = toReturn + sequence.substring(prevEnd, start);
                            toReturn = toReturn + '<span title="' + name + '" style="background-color:' + color + '">' + sequence.substring(start, end) + '</span>';
                            prevEnd = end;
                        }
                        //append end of string
                        toReturn = toReturn + sequence.substring(annotationsToDraw[annotationsToDraw.length - 1].end, sequence.length);
                    } else {
                        toReturn = sequence;
                    }
                    return toReturn;
                };
                var changeLength = 0;
                $('#testText').keydown(function() {
                    _sequence = $('#testText').val();
                    changeLength++;
                });

                $('#testText').keyup(function() {
                    var textArea = $('#testText')[0];
                    var unparsed = $('#testText').val();
                    changeLength = (unparsed.length - _sequence.length) * changeLength;
                    if (changeLength !== 0) {
                        _annotations = updateAnnotationIndices(textArea.selectionEnd, _annotations, changeLength);
                    }
                    changeLength = 0;
                    var parsed = generateHighlights(unparsed, _annotations);

                    //set the html of the highlight layer
                    $('#highlight').html(parsed);
                    $('#highlight').css("z-index", -1);
                    $('#highlight span').css("color", "transparent");
                    $('#testText').css("color", "black");
                });


                // test page event handlers
                $('#sample1').click(function() {
                    resolveFeatureOverlap(samples[0].sequence, samples[0].features);
                    $('#testText').val(samples[0].sequence);
                });
                $('#sample2').click(function() {
                    resolveFeatureOverlap(samples[1].sequence, samples[1].features);
                    $('#testText').val(samples[1].sequence);
                });
                $('#sample3').click(function() {
                    resolveFeatureOverlap(samples[2].sequence, samples[2].features);
                    $('#testText').val(samples[2].sequence);
                });
                $('#clear').click(function() {
                    $('#testText').val("");
                    $('#highlight').html("");
                });
                $('#annotate').click(function() {
                    _annotations = generateAnnotations($('#testText').val(), _features);
                    var parsed =generateHighlights($('#testText').val(), _annotations);
                    $('#highlight').html(parsed);
                    $('#highlight').css("z-index", -1);
                    $('#highlight span').css("color", "transparent");
                    $('#testText').css("color", "black");
                });
            });
        </script>
    </body>
</html>
